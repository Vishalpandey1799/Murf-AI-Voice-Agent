<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Assistant | AI Companion</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    /* --- Your existing CSS (kept as-is) --- */
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #10b981;
      --accent: #f59e0b;
      --dark-1: #0f172a;
      --dark-2: #1e293b;
      --dark-3: #334155;
      --light-1: #f1f5f9;
      --light-2: #e2e8f0;
      --error: #ef4444;
      --success: #10b981;
    }
    /* all your container, header, chat, buttons etc styles… (I kept them unchanged) */

    /* --- Modal styles --- */

  </style>
</head>
<body>
  <!-- Background elements -->
  <div class="bg-blob blob-1"></div>
  <div class="bg-blob blob-2"></div>
  <div class="bg-blob blob-3"></div>

  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-robot"></i>
      </div>
      <h1 class="title">Voice Assistant</h1>
      <div class="status">
        <div class="status-dot"></div>
        <span>Online</span>
      </div>
      <div class="settings">
        <button id="settingsBtn"><i class="fas fa-cog"></i></button>
      </div>
    </div>
    
    <div id="chat-log">
      <div class="welcome-message">
        <h4>Hello! I'm your AI Assistant</h4>
        <p>Press the button below to start a conversation with me</p>
      </div>
      
      <div class="message received">
        <span>Ready when you are! Just press "Start Conversation" to begin.</span>
        <div class="timestamp">Just now</div>
      </div>
    </div>

    <div class="controls">
      <button id="startAndstopBtn">
        <i class="fas fa-microphone"></i> Start Conversation
      </button>
      <div class="loading" id="loading">
        <div class="loading-text">AI is thinking</div>
        <div class="loading-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>Secure & Private • Powered by AI</p>
    </div>
  </div>

  <!-- Config Modal -->
  <div id="configModal" class="modal hidden">
    <div class="modal-content">
      <h2>Configuration</h2>
      <label>Gemini API Key</label>
      <input type="password" id="geminiKey" placeholder="Enter Gemini API Key">
      
      <label>Murf API Key</label>
      <input type="password" id="murfKey" placeholder="Enter Murf API Key">
      
      <label>STT API Key</label>
      <input type="password" id="sttKey" placeholder="Enter STT API Key">
      
      <button id="saveKeysBtn">Save</button>
    </div>
  </div>

  <script>
    const startAndstopBtn = document.getElementById('startAndstopBtn');
    const chatLog = document.getElementById('chat-log');
    const loadingIndicator = document.getElementById('loading');
    const settingsBtn = document.getElementById("settingsBtn");
    const configModal = document.getElementById("configModal");
    const saveKeysBtn = document.getElementById("saveKeysBtn");

    let isRecording = false;
    let ws = null;
    let stream;
    let audioCtx;
    let source;
    let processor;
    let audioContext;
    let playheadTime = 0;

    function getSessionId() {
      const params = new URLSearchParams(window.location.search);
      let id = params.get("session");
      if (!id) {
        id = crypto.randomUUID();
        params.set("session", id);
        window.history.replaceState({}, "", `${location.pathname}?${params}`);
      }
      return id;
    }
    const sessionId = getSessionId();

    // ---------- Chat UI helpers ----------
    function addTextMessage(text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', type);
      messageDiv.textContent = text;
      const timestamp = document.createElement('div');
      timestamp.classList.add('timestamp');
      timestamp.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      messageDiv.appendChild(timestamp);
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function playAudioChunk(base64Audio) {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
        playheadTime = audioContext.currentTime;
      }
      const binary = atob(base64Audio);
      const byteArray = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) byteArray[i] = binary.charCodeAt(i);
      const view = new DataView(byteArray.buffer);
      const sampleCount = byteArray.length / 2;
      const float32Array = new Float32Array(sampleCount);
      for (let i = 0; i < sampleCount; i++) {
        const int16 = view.getInt16(i*2, true);
        float32Array[i] = int16 / 32768;
      }
      const buffer = audioContext.createBuffer(1, float32Array.length, 44100);
      buffer.copyToChannel(float32Array, 0);
      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      const now = audioContext.currentTime;
      if (playheadTime < now + 0.15) playheadTime = now + 0.15;
      source.start(playheadTime);
      playheadTime += buffer.duration;
    }

    async function startRecording() {
      // check keys first
      const res = await fetch(`/keys/${sessionId}`);
      if (!res.ok) {
        alert("Please configure your API keys first!");
        return;
      }
      ws = new WebSocket("ws://127.0.0.1:8000/ws");
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "transcript") addTextMessage(msg.text, "sent");
          else if (msg.type === "ai_response") addTextMessage(msg.text, "received");
          else if (msg.type === "audio_chunk") playAudioChunk(msg.audio);
        } catch (err) { console.error("WS msg error", err); }
      };
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new AudioContext({ sampleRate: 16000 });
      source = audioCtx.createMediaStreamSource(stream);
      processor = audioCtx.createScriptProcessor(4096, 1, 1);
      source.connect(processor);
      processor.connect(audioCtx.destination);
      processor.onaudioprocess = (e) => {
        const inputData = e.inputBuffer.getChannelData(0);
        const buffer = new ArrayBuffer(inputData.length * 2);
        const view = new DataView(buffer);
        for (let i = 0; i < inputData.length; i++) {
          let s = Math.max(-1, Math.min(1, inputData[i]));
          view.setInt16(i*2, s<0?s*0x8000:s*0x7fff, true);
        }
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(buffer);
      };
    }
    function stopRecording() {
      if (processor) processor.disconnect();
      if (source) source.disconnect();
      if (audioCtx) audioCtx.close();
      if (stream) stream.getTracks().forEach(t=>t.stop());
      if (ws) ws.close();
    }

    startAndstopBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!isRecording) {
        await startRecording();
        isRecording = true;
        startAndstopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
        startAndstopBtn.classList.add("recording");
      } else {
        stopRecording();
        isRecording = false;
        startAndstopBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Conversation';
        startAndstopBtn.classList.remove("recording");
      }
    });

    // -------- Settings Modal ----------
    settingsBtn.addEventListener("click", () => {
      configModal.classList.remove("hidden");
    });
    saveKeysBtn.addEventListener("click", async () => {
      const keys = {
        gemini: document.getElementById("geminiKey").value,
        murf: document.getElementById("murfKey").value,
        stt: document.getElementById("sttKey").value
      };
      const res = await fetch(`/set_keys/${sessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(keys)
      });
      if (res.ok) {
        alert("Keys saved!");
        configModal.classList.add("hidden");
      } else {
        alert("Failed to save keys.");
      }
    });
  </script>
</body>
</html>
